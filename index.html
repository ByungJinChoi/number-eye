<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>XROBO Number â€” ì•ˆì •í™” ë²„ì „</title>
<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
:root{
  --headerH:64px;
  --uiScale:1;
  --rightW: 34vw;
  --dividerH: 8px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#0b1020;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,sans-serif;}
button{cursor:pointer;border:0;border-radius:8px;background:#1f2937;color:#e5e7eb;padding:.55rem .8rem;font-weight:600}
button.small{padding:.35rem .6rem;font-size:.9rem;border-radius:6px}
button.primary{background:#2563eb}
button:disabled{opacity:.6;cursor:not-allowed}
.btnRow{display:flex;gap:.5rem;align-items:center}

#appHeader{position:fixed;left:0;top:0;right:0;height:var(--headerH);padding:.5rem .8rem;background:#0f172a;border-bottom:1px solid #111827;display:flex;align-items:center;gap:.8rem;z-index:10}
#brand{font-weight:800;letter-spacing:.5px}
#brand small{color:#9ca3af;font-weight:600;margin-left:.4rem}

/* ë ˆì´ì•„ì›ƒ */
#main{position:absolute;left:0;right:0;top:var(--headerH);bottom:0;display:flex;gap:0}
#left{flex:1;min-width:40vw;position:relative}
#blocklyDiv{position:absolute;left:0;top:0;right:0;bottom:0}
#panelHandle{position:absolute;top:12px;right:12px;width:20px;height:20px;border-radius:999rem;background:#334155}
#panelHandle::after{content:'';display:block;width:12px;height:12px;border-right:3px solid #94a3b8;border-bottom:3px solid #94a3b8;transform:rotate(-45deg);margin:3px auto}
#panelHandle.closed::after{transform:rotate(135deg)}
#hResizer{width:6px;background:#0b1020;cursor:col-resize}

#right{width:var(--rightW);min-width:320px;background:#0b122a;border-left:1px solid #0f172a;display:flex;flex-direction:column}
#rightTop{flex:1;min-height:150px;display:flex;align-items:center;justify-content:center;padding:10px}
.camWrap{position:relative;width:100%;height:100%;background:#0b0f1f;border-radius:12px;border:1px solid #111827;overflow:hidden}
.camWrap video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)} /* ê±°ìš¸ ëª¨ë“œ */
.camBadge{position:absolute;left:10px;top:10px;background:#111827;border:1px solid #1f2937;border-radius:999rem;padding:.25rem .5rem;font-size:12px;color:#9ca3af}
.camUi{position:absolute;right:10px;top:10px;display:flex;gap:.5rem}
#focusBox{position:absolute;border:2px dashed rgba(226,232,240,.65);border-radius:10px;pointer-events:none}
#digitReadout{position:absolute;left:10px;bottom:10px;background:rgba(0,0,0,.55);border:1px solid #111827;border-radius:10px;padding:.35rem .6rem;font-weight:800}
#digitReadout .label{color:#93c5fd;margin-right:.4rem}

#rightDivider{height:var(--dividerH);cursor:row-resize;background:linear-gradient(#111827,#0f172a)}
#rightBottom{flex:1;min-height:120px;padding:10px;overflow:auto}
#log{font: 12px/1.4 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word;background:#0b0f1f;border:1px solid #111827;border-radius:10px;padding:10px;height:100%}
.log-time{color:#64748b}
.log-line strong{color:#eab308}

/* ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´(ëˆˆë™ìëŠ” ìœ ì§€í•˜ì§€ë§Œ ê¸°ë³¸ì€ ë¹„í™œì„±) */
#playOverlay{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center}
#playOverlay.show{display:flex}
#playOverlay .body{position:relative;width:100%;height:100%;background:#000}
#eyesCam{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
#overlayDigitBadge{position:absolute;left:14px;bottom:14px;background:rgba(0,0,0,.55);border:1px solid #111827;border-radius:10px;padding:.4rem .6rem;font-weight:800}
#eyesStage{display:none}

/* ìˆ¨ê¹€ ì ‘ê·¼ì„± */
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
</style>
</head>
<body>
  <header id="appHeader">
    <div id="brand">XROBO <small>Number OCR</small></div>
    <div class="btnRow">
      <button id="btnConnect">ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°</button>
      <button id="btnTest" class="primary">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
      <button id="btnStop">ì •ì§€</button>
      <button id="fsBtn">ì „ì²´í™”ë©´</button>
    </div>
    <div style="margin-left:auto;color:#9ca3af;font-size:12px">ì¸ì‹ ì£¼ê¸°: <strong id="rateLabel">0.5s</strong> Â· ì—”ì§„: Tesseract.js</div>
  </header>

  <div id="main">
    <div id="left">
      <div id="blocklyDiv" role="application" aria-label="ì½”ë”© ë¸”ë¡ í¸ì§‘ê¸°"></div>
      <button id="panelHandle" class="open" title="ì‹¤í–‰ì°½ ë‹«ê¸°"></button>
    </div>
    <div id="hResizer" class="hsplit" title="ì¢Œìš° í¬ê¸° ì¡°ì ˆ ë°”"></div>

    <div id="right">
      <div id="rightTop">
        <div class="camWrap" id="camWrap">
          <video id="camVideo" playsinline autoplay muted></video>
          <div id="focusBox" aria-hidden="true"></div>
          <div class="camUi">
            <span id="camBadge" class="camBadge">Cam: off</span>
            <button id="camToggle" class="btn small">ìº  ì¼œê¸°</button>
          </div>
          <div id="digitReadout"><span class="label">ìˆ«ì</span><span class="value">â€”</span></div>
        </div>
      </div>
      <div id="rightDivider" title="ë“œë˜ê·¸í•˜ì—¬ ë¡œê·¸ ë†’ì´ ì¡°ì ˆ"></div>
      <div id="rightBottom">
        <div style="font-size:calc(12px * var(--uiScale));color:#9ca3af;">ì‹¤í–‰ ë¡œê·¸</div>
        <div id="log" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- TOOLBOX -->
  <xml id="toolbox" style="display:none">
    <category name="ì´ë²¤íŠ¸" colour="#f59e0b">
      <block type="xrobo_start"></block>
    </category>
    <category name="ì¶œë ¥" colour="#60a5fa">
      <block type="motor12_dd">
        <field name="M1">20</field><field name="M2">20</field><field name="MS">500</field>
      </block>
      <block type="motor12_in">
        <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
        <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
      </block>
      <block type="melody">
        <field name="PITCH">C4</field>
        <value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value>
        <value name="WAIT"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="led_ctrl">
        <field name="TGT">OUT1</field>
        <field name="MODE">BRIGHT</field>
        <field name="VAL">10</field>
      </block>
    </category>
    <category name="ì œì–´" colour="#10b981">
      <block type="controls_repeat_ext">
        <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
      </block>
      <block type="wait_seconds">
        <value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
    </category>
  </xml>

  <!-- ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´(ì¹´ë©”ë¼+ë°°ì§€) -->
  <div id="playOverlay" aria-hidden="true">
    <div class="body">
      <video id="eyesCam" playsinline muted autoplay></video>
      <div id="eyesStage" aria-label="ëˆˆë™ì"></div>
      <div id="overlayDigitBadge"><span class="label">ìˆ«ì</span> <span class="value">â€”</span></div>
    </div>
  </div>

<script>
/* ================= Blockly ê¸°ë³¸ ì„¤ì • ================= */
class XroboZelosProvider extends Blockly.zelos.ConstantProvider { constructor(){ super(); this.ADD_START_HATS = true; } }
class XroboZelosRenderer extends Blockly.zelos.Renderer { constructor(){ super('xrobo_zelos'); } makeConstants_(){ return new XroboZelosProvider(); } }
Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);
const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', { base: Blockly.Themes.Zelos, componentStyles: { startHats: true }});

var ws = Blockly.inject('blocklyDiv', {
  toolbox: document.getElementById('toolbox'),
  renderer: 'xrobo_zelos',
  theme: XroboTheme,
  grid: { spacing:20, length:3, colour:'#111827', snap:true },
  zoom: { controls:true, wheel:true, startScale:1, minScale:.6, maxScale:1.7 },
  move: { scrollbars:true, drag:true, wheel:true },
  trashcan: true
});

/* â–¼â–¼ Blockly v12 ë³€ìˆ˜ API ê²½ê³  ì œê±°ìš© SHIM â–¼â–¼ */
(function patchBlocklyDeprecated(){
  try{
    if (Blockly.Workspace && Blockly.Workspace.prototype && Blockly.Workspace.prototype.getAllVariables) {
      Blockly.Workspace.prototype.getAllVariables = function(){
        var vm = this.getVariableMap ? this.getVariableMap() : null;
        return (vm && vm.getAllVariables) ? vm.getAllVariables() : [];
      };
    }
  }catch(e){}
})();
/* â–²â–² SHIM ë â–²â–² */

/* ================= ìƒìˆ˜/ê³µìš© ================= */
var PINS_OUT=[["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]];
var SPEEDS=Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
var TIMES100=Array.from({length:10},(_,i)=>100*(i+1)).map(v=>[String(v),String(v)]);
var LED_TGT=[].concat(PINS_OUT,[["CPU","CPU"]]);
var LED_MODE=[["ë°ê¸°","BRIGHT"],["ìˆ¨ì‰¬ê¸°","BREATHE"]];
var LED_VALS=Array.from({length:20},(_,i)=>[String(i),String(i)]);

/* ================= ë¸”ë¡ ì •ì˜ ================= */
const DIGIT_OPTIONS = Array.from({length:10}, (_,i)=>[String(i), 'D'+i]);
Blockly.defineBlocksWithJsonArray([
  { "type":"xrobo_start", "message0":"ìˆ«ì %1 ì´ ë³´ì´ë©´",
    "args0":[{ "type":"field_dropdown","name":"DIGIT","options": DIGIT_OPTIONS }],
    "nextStatement":null, "colour":36, "hat":"cap"
  },
  { "type":"motor12_dd","message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
    "args0":[{"type":"field_dropdown","name":"M1","options":SPEEDS},{"type":"field_dropdown","name":"M2","options":SPEEDS},{"type":"field_dropdown","name":"MS","options":TIMES100}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
  { "type":"motor12_in","message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
    "args0":[{"type":"input_value","name":"M1","check":"Number"},{"type":"input_value","name":"M2","check":"Number"},{"type":"input_value","name":"MS","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":210 },
  { "type":"melody","message0":"ë©œë¡œë”” ìŒë†’ì´ %1 ì†Œë¦¬ì‹œê°„ %2 ms ëŒ€ê¸°ì‹œê°„ %3 ms",
    "args0":[{"type":"field_dropdown","name":"PITCH","options":(function(){var KR=["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"], EN=["C","D","E","F","G","A","B"], L=[]; for(var o=4;o<=6;o++) for(var i=0;i<7;i++) L.push([KR[i]+o, EN[i]+o]); return L;})()},
             {"type":"input_value","name":"DUR","check":"Number"},{"type":"input_value","name":"WAIT","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":300 },
  { "type":"led_ctrl","message0":"LED %1 ëª¨ë“œ %2 ê°’ %3",
    "args0":[{"type":"field_dropdown","name":"TGT","options":LED_TGT},{"type":"field_dropdown","name":"MODE","options":LED_MODE},{"type":"field_dropdown","name":"VAL","options":LED_VALS}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":330 },
  { "type":"wait_seconds","message0":"%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
    "args0":[{"type":"input_value","name":"SEC","check":"Number"}],
    "previousStatement":null,"nextStatement":null,"inputsInline":true,"colour":120 }
]);

/* ================= ì½”ë“œ ë¹Œë” ================= */
function numFromInput(parent, name, def){ if (def===void 0) def=0;
  var raw = Blockly.JavaScript.valueToCode(parent, name, Blockly.JavaScript.ORDER_NONE);
  var n = Number(raw != null ? raw : ''); return (isFinite(n) ? n : def);
}
function walkNode(b, list){
  if(!b) return;
  switch(b.type){
    case 'motor12_dd':{
      var v1=+b.getFieldValue('M1'),v2=+b.getFieldValue('M2'),ms=+b.getFieldValue('MS');
      list.push({type:'CMD',s:'M12 '+v1+' '+v2+' '+ms}); if(ms>0) list.push({type:'W',args:[ms]}); break; }
    case 'motor12_in':{
      var v1n=numFromInput(b,'M1',0),v2n=numFromInput(b,'M2',0),msn=numFromInput(b,'MS',0);
      list.push({type:'CMD',s:'M12 '+Math.round(v1n)+' '+Math.round(v2n)+' '+Math.round(msn)}); if(msn>0) list.push({type:'W',args:[msn]}); break; }
    case 'melody':{
      var p=b.getFieldValue('PITCH'),dur=numFromInput(b,'DUR',200),wait=numFromInput(b,'WAIT',0);
      list.push({type:'CMD',s:'MEL '+p+' '+Math.round(dur)+' '+Math.round(wait)}); if(wait>0) list.push({type:'W',args:[wait]}); break; }
    case 'led_ctrl':{
      var t=b.getFieldValue('TGT'),m=b.getFieldValue('MODE'),v=+b.getFieldValue('VAL');
      list.push({type:'CMD',s:'LED '+t+' '+m+' '+v}); break; }
    case 'controls_repeat_ext':{
      var times=Math.max(0, numFromInput(b,'TIMES',1));
      var inner=[]; var first=b.getInputTargetBlock('DO'); walkChain(first, inner);
      list.push({type:'FOR',count:times,body:inner}); break; }
    case 'wait_seconds':{
      var s=numFromInput(b,'SEC',1); if(s>0) list.push({type:'W',args:[s*1000]}); break; }
  }
}
function walkChain(start, list){ for(var n=start; n; n=n.getNextBlock()) walkNode(n, list); }
function normalizeProgram(list){
  var out=[]; for(var i=0;i<list.length;i++){
    var ins=list[i];
    if(ins.type==='CMD'){ var prev=out[out.length-1]; if(prev && prev.type==='CMD' && prev.s===ins.s) continue; }
    else if(ins.type==='W'){
      if(!isFinite(ins.args && ins.args[0]) || ins.args[0]<=0) continue;
      var prevw=out[out.length-1]; if(prevw && prevw.type==='W'){ prevw.args[0]+=ins.args[0]; continue; }
    }
    out.push(ins);
  }
  return out;
}
function buildEventPrograms(){
  const programs = { D0:[], D1:[], D2:[], D3:[], D4:[], D5:[], D6:[], D7:[], D8:[], D9:[] };
  var evs = ws.getBlocksByType('xrobo_start', true);
  for(var i=0;i<evs.length;i++){
    var code = evs[i].getFieldValue('DIGIT') || 'D0';
    var chain = evs[i].getNextBlock(); if(!chain) continue;
    var prog=[]; walkChain(chain, prog);
    var norm = normalizeProgram(prog);
    programs[code] = programs[code].concat(norm);
  }
  return programs;
}

/* ================= íŒ¨ë„ í† ê¸€ ================= */
var panelHandle=document.getElementById('panelHandle');
function togglePanel(){ document.body.classList.toggle('panel-collapsed'); setTimeout(()=>{ Blockly.svgResize(ws); },60); }
panelHandle.addEventListener('click', togglePanel);

/* ================= ì‹¤í–‰/í…ŒìŠ¤íŠ¸ & í ì—”ì§„ ================= */
var overlay=document.getElementById('playOverlay');
var eventPrograms = {};
var queue = [];
var queueBusy = false;
var cancelToken = 0;
var isRunning = false;
var isFullscreenRun = false;

function enc(s){ return new TextEncoder().encode(s); }
function log(msg){
  var el=document.getElementById('log');
  var t=new Date(); var hh=String(t.getHours()).padStart(2,'0');var mm=String(t.getMinutes()).padStart(2,'0');var ss=String(t.getSeconds()).padStart(2,'0');
  el.insertAdjacentHTML('afterbegin', '<div class="log-line"><span class="log-time">['+hh+':'+mm+':'+ss+']</span> '+msg+'</div>');
}
function setRunning(v){
  isRunning = !!v;
  document.getElementById('btnTest').disabled = v;
  document.getElementById('btnStop').disabled = !v;
}
function sendRaw(s){
  if(!window.writeChar){ log('â¡ï¸(BLE ë¯¸ì—°ê²°) '+s); return Promise.resolve(); }
  return window.writeChar.writeValue(enc(s+'\\n')).then(()=>{ log('â¡ï¸ '+s); }).catch(e=>{ log('âš ï¸ ì „ì†¡ ì‹¤íŒ¨: '+e); });
}
async function runList(list, token){
  for(var i=0;i<list.length;i++){
    if(token!==cancelToken) return;
    var ins=list[i];
    if(ins.type==='CMD'){ await sendRaw(ins.s); }
    else if(ins.type==='W'){ var ms=(ins.args&&ins.args[0])?ins.args[0]:0; if(ms>0) await new Promise(r=>setTimeout(r,ms)); }
    else if(ins.type==='FOR'){
      for(var k=0;k<ins.count;k++){ if(token!==cancelToken) return; await runList(ins.body, token); }
    }
  }
}
async function processQueue(token){
  if(queueBusy) return;
  queueBusy=true;
  try{
    while(queue.length && token===cancelToken){
      var item = queue.shift();
      await runList(item.list, token);
    }
  }finally{ queueBusy=false; }
}
function triggerEvent(name){
  if(!isRunning) return;
  var seq = eventPrograms[name];
  if(seq && seq.length){
    queue.push({list: seq});
    processQueue(cancelToken);
  }
}
function startTest(){
  if(isRunning) return;
  eventPrograms = buildEventPrograms();
  cancelToken++; queue=[];
  isFullscreenRun = false;
  setRunning(true);
  log('â–¶ï¸ í…ŒìŠ¤íŠ¸ ì‹œì‘');
}
async function stopRun(){
  cancelToken++; queue=[];
  setRunning(false);
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  if(document.fullscreenElement && document.exitFullscreen){ try{ await document.exitFullscreen(); }catch(e){} }
  log('â¹ ì •ì§€');
}

/* ================= ë¸”ë£¨íˆ¬ìŠ¤ (ê¸°ì¡´ ì½”ë“œì™€ í˜¸í™˜ë˜ë„ë¡ ìµœì†Œ) ================= */
let bleDevice=null, writeChar=null;
async function connectBle(){
  try{
    const serviceUUID = 0xFFE0;          // í”í•œ UART ì„œë¹„ìŠ¤ (ì‚¬ìš©í•˜ë˜ ê°’ ìœ ì§€)
    const charUUID = 0xFFE1;
    bleDevice = await navigator.bluetooth.requestDevice({ filters:[{ services:[serviceUUID] }] });
    const server = await bleDevice.gatt.connect();
    const service = await server.getPrimaryService(serviceUUID);
    writeChar = await service.getCharacteristic(charUUID);
    log('âœ… BLE ì—°ê²° ì™„ë£Œ');
  }catch(e){ log('âš ï¸ BLE ì—°ê²° ì‹¤íŒ¨: '+e); }
}

/* ================= ì¹´ë©”ë¼ / OCR ================= */
const video = document.getElementById('camVideo');
const eyesCam = document.getElementById('eyesCam');
const camBadge = document.getElementById('camBadge');
const camToggle = document.getElementById('camToggle');
const focusBox = document.getElementById('focusBox');
const digitRead = document.querySelector('#digitReadout .value');
const overlayDigit = document.querySelector('#overlayDigitBadge .value');
let camStream=null, camOn=false;

const W=320, H=240;            // ë‚´ë¶€ ì²˜ë¦¬ í•´ìƒë„
const ROI_RATIO = 0.70;        // ì¸ì‹ ì°½(ë” í¬ê²Œ) â€” ì¤‘ì•™ 70%
const OCR_INTERVAL_MS = 500;   // 0.5ì´ˆ ê°„ê²©
document.getElementById('rateLabel').textContent = (OCR_INTERVAL_MS/1000)+'s';
let ocrReady=false, ocrBusy=false, lastTs=0, lastDigit=null, lastPrinted=null;

const workCanvas = document.createElement('canvas');
const workCtx = workCanvas.getContext('2d',{willReadFrequently:true});
workCanvas.width=W; workCanvas.height=H;

function updateFocusBox(){
  const wrap = document.getElementById('camWrap');
  const rw = wrap.clientWidth, rh = wrap.clientHeight;
  const fw = Math.round(rw*ROI_RATIO), fh = Math.round(rh*ROI_RATIO);
  const fx = Math.round((rw-fw)/2), fy = Math.round((rh-fh)/2);
  focusBox.style.left = fx+'px'; focusBox.style.top = fy+'px';
  focusBox.style.width = fw+'px'; focusBox.style.height = fh+'px';
}
window.addEventListener('resize', updateFocusBox);

/* ê³ ì • ì´ˆì (ê°€ëŠ¥í•œ ë¸Œë¼ìš°ì €ì—ì„œë§Œ) */
function withFocusConstraint(base){ 
  base = base||{};
  base.video = base.video||{};
  base.video.advanced = base.video.advanced||[{focusMode:'manual'}];
  return base;
}
async function startCam(){
  if(camOn) return;
  try{
    const constraints = withFocusConstraint({ video:{ facingMode: 'environment'} , audio:false });
    camStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = camStream; eyesCam.srcObject = camStream;
    await video.play();
    camOn=true; camBadge.textContent='Cam: on'; camToggle.textContent='ìº  ë„ê¸°';
    updateFocusBox();
    log('ğŸ“· ì¹´ë©”ë¼ ì¼œì§');
    // ì²« í”„ë ˆì„ ì¤€ë¹„ í›„ OCR ë£¨í”„ ì‹œë™
    setTimeout(()=>{ startDetectLoop(); }, 100);
  }catch(e){
    log('âš ï¸ ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨: '+e);
  }
}
function stopCam(){
  if(!camOn) return;
  camStream.getTracks().forEach(t=>t.stop());
  camStream=null; camOn=false; camBadge.textContent='Cam: off'; camToggle.textContent='ìº  ì¼œê¸°';
  log('ğŸ“· ì¹´ë©”ë¼ êº¼ì§');
}

/* OCR ì¤€ë¹„: v2/v5 í˜¸í™˜ (good.html ë°©ì‹) */
let ocrWorker=null, ocrMode='direct';
async function ensureOcr(){
  if(ocrReady) return;
  try{
    if(Tesseract && typeof Tesseract.createWorker==='function'){
      ocrMode='worker';
      ocrWorker = await Tesseract.createWorker();
      await ocrWorker.loadLanguage('eng');
      await ocrWorker.initialize('eng');
      await ocrWorker.setParameters({
        tessedit_char_whitelist: '0123456789',
        tessedit_pageseg_mode: '6'  // ë‹¨ì¼ ë¸”ë¡(í•œ ê¸€ìë§Œ ì•„ë‹ ë•Œ ë” ì•ˆì •ì )
      });
      ocrReady=true;
      log('ğŸ§  OCR ì¤€ë¹„ ì™„ë£Œ (worker)');
    }else if(Tesseract && typeof Tesseract.recognize==='function'){
      ocrMode='direct';
      ocrReady=true;
      log('ğŸ§  OCR ì¤€ë¹„ ì™„ë£Œ (direct)');
    }else{
      throw new Error('Tesseract.js ë¡œë”© ì‹¤íŒ¨');
    }
  }catch(e){
    log('âš ï¸ OCR ì´ˆê¸°í™” ì‹¤íŒ¨: '+e);
  }
}

/* í”„ë ˆì„ ì „ì²˜ë¦¬ (ê±°ìš¸ ëª¨ë“œ ìœ ì§€, ì¤‘ì•™ ROI í™•ëŒ€) */
function drawToCanvas(){
  const vw = video.videoWidth||0, vh = video.videoHeight||0;
  if(!vw || !vh) return false;
  // ì „ì²´ë¥¼ ë‚´ë¶€ ìº”ë²„ìŠ¤ì— ë¨¼ì € ì±„ìš°ê¸°
  workCtx.save();
  workCtx.scale(-1,1);               // ì¢Œìš° ë°˜ì „(ë¹„ë””ì˜¤ì™€ ë™ì¼)
  workCtx.drawImage(video, -W, 0, W, H);
  workCtx.restore();

  // ROI í¬ë¡­ â€” ì¤‘ì•™ 70%
  const rx = Math.round((W - W*ROI_RATIO)/2);
  const ry = Math.round((H - H*ROI_RATIO)/2);
  const rw = Math.round(W*ROI_RATIO), rh = Math.round(H*ROI_RATIO);
  const img = workCtx.getImageData(rx, ry, rw, rh);

  // ê°„ë‹¨í•œ ëŒ€ë¹„ í–¥ìƒ + ê·¸ë ˆì´ ìŠ¤ì¼€ì¼
  const d = img.data, n=d.length;
  // ì „ì²´ í‰ê·  ë°ê¸°
  let sum=0; for(let i=0;i<n;i+=4){ sum += (d[i]+d[i+1]+d[i+2])/3; }
  const mean = sum/(n/4);
  const gain = mean<100 ? 1.35 : (mean>180 ? 0.85 : 1.0);

  for(let i=0;i<n;i+=4){
    let g = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
    g = Math.max(0, Math.min(255, (g-128)*gain + 128));
    d[i]=d[i+1]=d[i+2]=g;
  }
  // ROIë¥¼ ë‹¤ì‹œ  W x H ì— ì¤‘ì•™ ë°°ì¹˜
  workCtx.fillStyle='#000'; workCtx.fillRect(0,0,W,H);
  workCtx.putImageData(img, rx, ry);
  return true;
}

async function recognizeDigit(){
  if(!drawToCanvas()) return {digit:null, conf:0};
  const cfg = { tessedit_char_whitelist: '0123456789', tessedit_pageseg_mode: '6' };
  try{
    let ret;
    if(ocrMode==='worker' && ocrWorker){
      ret = await ocrWorker.recognize(workCanvas, cfg);
    }else{
      ret = await Tesseract.recognize(workCanvas, 'eng', { logger: null, tessedit_char_whitelist:'0123456789', tessedit_pageseg_mode:'6' });
    }
    const data = ret && ret.data ? ret.data : {};
    const symbols = data.symbols || [];
    // digitë³„ confidence ëˆ„ì  í›„ ìµœê³ ê°’ ì„ íƒ
    const buckets = new Array(10).fill(0);
    for(const s of symbols){
      const ch = (s.text||'').trim();
      const c = typeof s.confidence==='number' ? s.confidence : (s.conf||0);
      if(/^[0-9]$/.test(ch)) buckets[+ch] += Math.max(0,c);
    }
    // fallback: ì „ì²´ textì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
    if(symbols.length===0 && typeof data.text==='string'){
      const m = data.text.replace(/\s+/g,'').match(/[0-9]/g);
      if(m && m.length){ for(const ch of m){ buckets[+ch]+=50; } }
    }
    let best=-1,bestIdx=null;
    for(let i=0;i<10;i++){ if(buckets[i]>best){ best=buckets[i]; bestIdx=i; } }
    // ì‹ ë¢°ë„ë¥¼ 0~100 ìŠ¤ì¼€ì¼ë¡œ ë³´ì •
    const conf = Math.max(0, Math.min(100, best));
    return { digit: bestIdx, conf: conf };
  }catch(e){
    log('âš ï¸ OCR ì¸ì‹ ì˜¤ë¥˜: '+e);
    return {digit:null, conf:0};
  }
}

/* ì£¼ê¸°ì  ë£¨í”„ â€” 0.5ì´ˆ ê°„ê²©, ë³€ê²½ì‹œì—ë§Œ ë¡œê·¸ */
function startDetectLoop(){
  ensureOcr(); // ë¹„ë™ê¸° ì¤€ë¹„
  function tick(){
    const now = performance.now();
    if(!camOn){ setTimeout(tick, OCR_INTERVAL_MS); return; }
    if(ocrBusy){ setTimeout(tick, 60); return; }
    if(now - lastTs < OCR_INTERVAL_MS){ setTimeout(tick, 60); return; }
    lastTs = now;
    ocrBusy = true;
    recognizeDigit().then(({digit, conf})=>{
      ocrBusy=false;
      const confPct = (conf||0).toFixed(1)+'%';
      if(digit!==null){
        // í™”ë©´ í‘œì‹œ
        digitRead.textContent = String(digit);
        overlayDigit.textContent = String(digit);
        // ë¡œê·¸ â€” ê°’ì´ ë°”ë€” ë•Œë§Œ
        if(lastPrinted!==digit){
          log('number : '+digit+'  '+confPct);
          lastPrinted = digit;
        }
        // ì‹¤í–‰ ì¤‘ì´ë©´ ì´ë²¤íŠ¸ë„ íŠ¸ë¦¬ê±°
        if(isRunning && conf>=40){
          triggerEvent('D'+digit);
        }
        lastDigit = digit;
      }else{
        digitRead.textContent = 'â€”';
        if(lastPrinted!==null){
          log('number : â€”');
          lastPrinted = null;
        }
        lastDigit = null;
      }
    }).catch(e=>{ ocrBusy=false; log('âš ï¸ OCR ì˜¤ë¥˜: '+e); });
    setTimeout(tick, 0); // ë‹¤ìŒ ì£¼ê¸° ìŠ¤ì¼€ì¤„ë§
  }
  tick();
}

/* ================= ë²„íŠ¼ & í•¸ë“¤ëŸ¬ ================= */
document.getElementById('btnConnect').onclick = connectBle;
document.getElementById('btnTest').onclick = startTest;
document.getElementById('btnStop').onclick = stopRun;

camToggle.onclick = ()=>{
  if(camOn) stopCam(); else startCam();
};
document.getElementById('camWrap').addEventListener('click', ()=>{
  if(!camOn) startCam();
});
document.getElementById('rightDivider').addEventListener('mousedown', function(e){
  e.preventDefault();
  const startY = e.clientY; const topH = document.getElementById('rightTop').offsetHeight;
  function mm(ev){
    const dy = ev.clientY - startY;
    const nh = Math.max(120, topH + dy);
    document.getElementById('rightTop').style.height = nh+'px';
    updateFocusBox();
  }
  function up(){ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up); }
  document.addEventListener('mousemove', mm);
  document.addEventListener('mouseup', up);
});
document.getElementById('hResizer').addEventListener('mousedown', function(e){
  e.preventDefault();
  const startX = e.clientX; const startW = document.getElementById('right').offsetWidth;
  function mm(ev){
    const dx = startX - ev.clientX;
    const nw = Math.max(320, startW + dx);
    document.documentElement.style.setProperty('--rightW', nw+'px');
    Blockly.svgResize(ws);
    updateFocusBox();
  }
  function up(){ document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up); }
  document.addEventListener('mousemove', mm);
  document.addEventListener('mouseup', up);
});

/* ì „ì²´í™”ë©´ í† ê¸€ */
const fsBtn=document.getElementById('fsBtn');
async function enterFS(){ var el=document.documentElement; if(el.requestFullscreen) await el.requestFullscreen(); }
async function exitFS(){ if(document.fullscreenElement && document.exitFullscreen) await document.exitFullscreen(); }
fsBtn.onclick = async ()=>{ if(document.fullscreenElement) await exitFS(); else await enterFS(); };

/* ì´ˆê¸° ìƒíƒœ ë¡œê·¸ */
log('âœ… ì¤€ë¹„ ì™„ë£Œ');
</script>
</body>
</html>
