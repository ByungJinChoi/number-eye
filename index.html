<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>Number Eye - ìˆ«ì ì¸ì‹ í…ŒìŠ¤íŠ¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<!-- Tesseract.js (ë¸Œë¼ìš°ì € OCR) -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #020617;
    color: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 16px;
  }
  .wrap {
    width: 100%;
    max-width: 640px;
    background: #020617;
    border-radius: 16px;
    border: 1px solid #1f2937;
    box-shadow: 0 18px 45px rgba(0,0,0,.65);
    padding: 16px 16px 20px;
  }
  h1 {
    margin: 0 0 12px;
    font-size: 20px;
    font-weight: 800;
    letter-spacing: .01em;
  }
  .desc {
    font-size: 13px;
    color: #9ca3af;
    margin-bottom: 12px;
  }
  .cam-box {
    position: relative;
    width: 100%;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #111827;
    aspect-ratio: 4 / 3;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    background: #000;
  }
  #roiBox {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 45%;
    aspect-ratio: 1 / 1;
    transform: translate(-50%, -50%);
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,.85);
    box-shadow: 0 0 0 1px rgba(0,0,0,.8), 0 0 16px rgba(56,189,248,.7);
    pointer-events: none;
  }
  .controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
  }
  button {
    border: 0;
    border-radius: 999px;
    padding: 8px 14px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    background: #2563eb;
    color: #fff;
  }
  button:disabled {
    opacity: .6;
    cursor: default;
  }
  #status {
    font-size: 13px;
    color: #9ca3af;
  }
  .result {
    margin-top: 14px;
    padding: 10px 12px;
    border-radius: 10px;
    background: #020617;
    border: 1px solid #1f2937;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .result-main {
    font-size: 16px;
    font-weight: 700;
  }
  .result-main span {
    font-size: 22px;
    padding-left: 4px;
  }
  .result-sub {
    font-size: 12px;
    color: #9ca3af;
    text-align: right;
  }
  details {
    margin-top: 10px;
    font-size: 12px;
  }
  summary {
    cursor: pointer;
    color: #9ca3af;
  }
  #log {
    margin-top: 6px;
    max-height: 120px;
    overflow-y: auto;
    padding: 8px;
    border-radius: 8px;
    background: #020617;
    border: 1px solid #1f2937;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 11px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Number Eye Â· ìˆ«ì ì¸ì‹ í…ŒìŠ¤íŠ¸</h1>
  <div class="desc">
    ê°€ìš´ë° ë„¤ëª¨ ë°•ìŠ¤ ì•ˆì— ìˆ«ì 1ê¸€ìë¥¼ í¬ê²Œ ë³´ì—¬ ì£¼ì„¸ìš”.<br>
    (ìƒ‰ì€ ììœ ì§€ë§Œ, ìˆ«ìì™€ ë°°ê²½ì˜ ë°ê¸° ì°¨ì´ê°€ í´ìˆ˜ë¡ ë” ì˜ ì¸ì‹ë©ë‹ˆë‹¤.)
  </div>

  <div class="cam-box">
    <video id="video" autoplay playsinline muted></video>
    <div id="roiBox"></div>
  </div>

  <div class="controls">
    <button id="camBtn">ì¹´ë©”ë¼ ì¼œê¸°</button>
    <span id="status">ëŒ€ê¸°ì¤‘â€¦</span>
  </div>

  <div class="result">
    <div class="result-main">
      ì¸ì‹ëœ ìˆ«ì:
      <span id="digit">-</span>
    </div>
    <div class="result-sub">
      ì‹ ë¢°ë„: <span id="conf">-</span>%<br>
      (ì ì • ì¸ì‹ë„ í¬í•¨)
    </div>
  </div>

  <details>
    <summary>ë””ë²„ê·¸ ë¡œê·¸ ë³´ê¸°</summary>
    <pre id="log"></pre>
  </details>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const video = document.getElementById('video');
  const camBtn = document.getElementById('camBtn');
  const statusEl = document.getElementById('status');
  const digitEl = document.getElementById('digit');
  const confEl = document.getElementById('conf');
  const logEl = document.getElementById('log');

  function log(msg) {
    const now = new Date();
    const t = now.toTimeString().slice(0,8);
    logEl.textContent += '[' + t + '] ' + msg + '\n';
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ---- OCR ê´€ë ¨ ì„¤ì • (ìˆ«ì 1ê¸€ì ì „ìš©) ----
  const OCR_W = 160;
  const OCR_H = 160;
  const OCR_INTERVAL_MS = 280;   // ìµœì†Œ ê°„ê²©(ms)
  const OCR_MIN_CONF = 55;       // ì´ ì´ìƒì¼ ë•Œë§Œ í™•ì •
  const OCR_HOLD_MS = 280;       // ê°™ì€ ìˆ«ìê°€ ì´ ì‹œê°„ ì´ìƒ ìœ ì§€ë˜ë©´ "í™•ì •"

  const ocrCanvas = document.createElement('canvas');
  ocrCanvas.width = OCR_W;
  ocrCanvas.height = OCR_H;
  const ocrCtx = ocrCanvas.getContext('2d', { willReadFrequently: true });

  let ocrWorker = null;
  let ocrReady = false;
  let ocrBusy = false;
  let ocrLastTs = 0;

  // Tesseract.js v5 / v2 í˜¸í™˜ ì´ˆê¸°í™”
  async function ensureOcr() {
    if (ocrReady) return;
    statusEl.textContent = 'OCR ì¤€ë¹„ ì¤‘â€¦';
    log('OCR ì´ˆê¸°í™” ì‹œì‘');
    try {
      // v5 ìš°ì„ : createWorker('eng', 1, options)
      try {
        ocrWorker = await Tesseract.createWorker('eng', 1, {
          logger: m => { /* console.log(m); */ }
        });
      } catch (e) {
        // êµ¬ë²„ì „(v2 ë“±) í˜¸í™˜ìš©
        ocrWorker = Tesseract.createWorker({
          logger: m => { /* console.log(m); */ }
        });
        if (ocrWorker.load)         await ocrWorker.load();
        if (ocrWorker.loadLanguage) await ocrWorker.loadLanguage('eng');
        if (ocrWorker.initialize)   await ocrWorker.initialize('eng');
      }
      if (ocrWorker.setParameters) {
        const psm =
          (Tesseract && Tesseract.PSM && Tesseract.PSM.SINGLE_CHAR)
            ? Tesseract.PSM.SINGLE_CHAR : 10;
        await ocrWorker.setParameters({
          tessedit_char_whitelist: '0123456789',
          tessedit_pageseg_mode: psm,
          user_defined_dpi: '300'
        });
      }
      ocrReady = true;
      statusEl.textContent = 'OCR ì¤€ë¹„ ì™„ë£Œ';
      log('ğŸ§  OCR ì¤€ë¹„ ì™„ë£Œ');
    } catch (e) {
      statusEl.textContent = 'OCR ì´ˆê¸°í™” ì‹¤íŒ¨';
      log('âŒ OCR ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e);
    }
  }

  // ì¤‘ì•™ ì •ì‚¬ê°í˜• ROI ê³„ì‚°
  function getCenterRoi(video, frac = 0.45) {
    const vw = Math.max(1, video.videoWidth || 320);
    const vh = Math.max(1, video.videoHeight || 240);
    const size = Math.round(Math.min(vw, vh) * frac);
    const x0 = Math.round((vw - size) / 2);
    const y0 = Math.round((vh - size) / 2);
    return { x: x0, y: y0, w: size, h: size };
  }

  // íšŒìƒ‰ â†’ ë‹¨ìˆœ ì„ê³„ ì²˜ë¦¬ë¥¼ í•´ì„œ ìˆ«ì ê°•ì¡°
  function preprocessToOcrCanvas(video, rect) {
    ocrCtx.drawImage(
      video,
      rect.x, rect.y, rect.w, rect.h,
      0, 0, OCR_W, OCR_H
    );
    const img = ocrCtx.getImageData(0, 0, OCR_W, OCR_H);
    const d = img.data;
    let sum = 0;

    // ê·¸ë ˆì´ìŠ¤ì¼€ì¼ + ì „ì²´ í‰ê· 
    for (let i = 0; i < d.length; i += 4) {
      const r = d[i], g = d[i + 1], b = d[i + 2];
      const gray = (r * 0.299 + g * 0.587 + b * 0.114);
      d[i] = d[i + 1] = d[i + 2] = gray;
      sum += gray;
    }

    const mean = sum / (OCR_W * OCR_H);
    const th = Math.max(40, Math.min(220, mean - 8));

    // ë‹¨ìˆœ ì´ì§„í™”
    for (let i = 0; i < d.length; i += 4) {
      const v = d[i] < th ? 0 : 255;
      d[i] = d[i + 1] = d[i + 2] = v;
      d[i + 3] = 255;
    }
    ocrCtx.putImageData(img, 0, 0);
  }

  // ë¹„ë””ì˜¤ í•œ í”„ë ˆì„ì—ì„œ ìˆ«ì 1ê¸€ì OCR
  async function runOcrOnVideo(video) {
    if (!ocrReady || ocrBusy) return null;
    const now = performance.now();
    if (now - ocrLastTs < OCR_INTERVAL_MS) return null;
    if (video.readyState < 2) return null;

    ocrLastTs = now;
    const rect = getCenterRoi(video);
    preprocessToOcrCanvas(video, rect);

    try {
      ocrBusy = true;
      const res = await ocrWorker.recognize(ocrCanvas);
      let bestDigit = null;
      let bestConf = -1;

      // symbol ë ˆë²¨ì—ì„œ ê°€ì¥ ìì‹ ìˆëŠ” ìˆ«ì ì„ íƒ
      if (res && res.data && res.data.symbols && res.data.symbols.length) {
        for (const s of res.data.symbols) {
          const ch = (s.text || '').trim();
          if (/^[0-9]$/.test(ch)) {
            if (s.confidence > bestConf) {
              bestConf = s.confidence;
              bestDigit = ch;
            }
          }
        }
      }

      // symbolì´ ì—†ìœ¼ë©´ textì—ì„œ ìˆ«ì ì¶”ì¶œ
      if (!bestDigit &&
          res && res.data && typeof res.data.text === 'string') {
        const m = res.data.text.match(/[0-9]/);
        if (m) {
          bestDigit = m[0];
          bestConf = res.data.confidence || 0;
        }
      }

      ocrBusy = false;
      if (bestDigit != null && bestConf >= OCR_MIN_CONF) {
        return { digit: bestDigit, conf: bestConf | 0 };
      }
    } catch (e) {
      ocrBusy = false;
      // ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
    }
    return null;
  }

  // ì¸ì‹ ê²°ê³¼ë¥¼ ë¶€ë“œëŸ½ê²Œ í‘œì‹œ (ì ì • â†’ í™•ì •)
  let activeDigit = null;
  let candDigit = null;
  let candConf = null;
  let candSince = 0;

  function updateDigitDisplay(digit, conf, provisional) {
    if (digit == null) {
      digitEl.textContent = '-';
      confEl.textContent = '-';
      digitEl.style.opacity = 1;
      return;
    }
    digitEl.textContent = digit;
    confEl.textContent = conf != null ? conf : '-';
    digitEl.style.opacity = provisional ? 0.55 : 1;
  }

  let loopId = null;
  let camOn = false;

  function startLoop() {
    if (loopId != null) return;
    const step = async () => {
      if (!camOn) { loopId = null; return; }
      const out = await runOcrOnVideo(video);
      const now = performance.now();

      let frameDigit = null;
      let frameConf = null;
      if (out && out.digit != null) {
        frameDigit = String(out.digit);
        frameConf = out.conf;
      }

      // ì ì • í›„ë³´ ê°±ì‹ 
      if (candDigit !== frameDigit) {
        candDigit = frameDigit;
        candConf = frameConf;
        candSince = now;
        if (candDigit != null) {
          updateDigitDisplay(candDigit, candConf, true);
          statusEl.textContent = 'ì ì • ì¸ì‹: ' + candDigit;
        }
      }

      // ì¼ì • ì‹œê°„ ì´ìƒ ìœ ì§€ë˜ë©´ í™•ì •
      if (candDigit != null &&
          (now - candSince) >= OCR_HOLD_MS &&
          activeDigit !== candDigit) {
        activeDigit = candDigit;
        updateDigitDisplay(activeDigit, candConf, false);
        statusEl.textContent = 'í™•ì • ì¸ì‹: ' + activeDigit;
        log('ğŸ¯ ìˆ«ì ì¸ì‹: ' + activeDigit +
            ' (ì‹ ë¢°ë„ ' + (candConf || '-') + '%)');
      }

      loopId = requestAnimationFrame(step);
    };
    loopId = requestAnimationFrame(step);
  }

  async function startCam() {
    if (camOn) return;
    try {
      statusEl.textContent = 'ì¹´ë©”ë¼ ìš”ì²­ ì¤‘â€¦';
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' }, // í›„ë©´ ì¹´ë©”ë¼ ì„ í˜¸
          width: { ideal: 640 },
          height: { ideal: 480 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      camOn = true;
      camBtn.textContent = 'ì¹´ë©”ë¼ ë„ê¸°';
      statusEl.textContent = 'ì¹´ë©”ë¼ ì¼œì§, OCR ì¤€ë¹„ ì¤‘â€¦';
      log('ğŸ¥ ì¹´ë©”ë¼ ì¼œì§');
      await ensureOcr();
      startLoop();
    } catch (e) {
      statusEl.textContent = 'ì¹´ë©”ë¼ ì‚¬ìš© ë¶ˆê°€';
      log('âŒ ì¹´ë©”ë¼ ì‹¤íŒ¨: ' + e);
    }
  }

  function stopCam() {
    if (!camOn) return;
    try { video.pause(); } catch (_) {}
    if (video.srcObject) {
      try {
        video.srcObject.getTracks().forEach(t => t.stop());
      } catch (_) {}
      video.srcObject = null;
    }
    camOn = false;
    camBtn.textContent = 'ì¹´ë©”ë¼ ì¼œê¸°';
    statusEl.textContent = 'ëŒ€ê¸°ì¤‘â€¦';
    activeDigit = candDigit = candConf = null;
    updateDigitDisplay(null, null, false);
    if (loopId != null) {
      cancelAnimationFrame(loopId);
      loopId = null;
    }
    log('ğŸ›‘ ì¹´ë©”ë¼ êº¼ì§');
  }

  camBtn.addEventListener('click', () => {
    if (camOn) stopCam();
    else startCam();
  });

  log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. "ì¹´ë©”ë¼ ì¼œê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.');
});
</script>
</body>
</html>
