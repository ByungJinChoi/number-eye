<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>XROBO BLE â€” number (ì¹´ë©”ë¼ ì¸ì‹ ì—†ìŒ)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<!-- Blockly -->
<script src="https://unpkg.com/blockly/blockly.min.js"></script>

<style>
  :root{
    --headerH: 64px;
    --uiScale: 1;
    --btnH: 36px;
    --gap: 8px;
    --blue: #1d4ed8;
    --logH: 200px;
  }

  *{ box-sizing:border-box; }
  html, body{ height:100%; margin:0; }
  body{
    font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background:#ffffff;
    color:#111827;
  }

  /* ===== í—¤ë” ===== */
  header{
    padding:8px 12px;
    background:linear-gradient(180deg,#fff7ed,#fffbeb);
    border-bottom:1px solid #fed7aa;
    position:relative;
    z-index:10;
  }
  #topbar{
    display:flex;
    align-items:center;
    gap:calc(var(--gap) * var(--uiScale));
    flex-wrap:wrap;
  }
  .title{
    font-weight:800;
    letter-spacing:.2px;
    color:#7c2d12;
    margin-right:12px;
    font-size:calc(18px * var(--uiScale));
  }
  .spacer{ flex:1 1 auto; }

  .btn{
    height:calc(var(--btnH) * var(--uiScale));
    padding:0 calc(12px * var(--uiScale));
    border:0;
    border-radius:calc(10px * var(--uiScale));
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:calc(14px * var(--uiScale));
    font-weight:600;
    background:#f3f4f6;
    color:#111827;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    cursor:pointer;
    user-select:none;
    gap:4px;
  }
  .btn.small{
    height:calc(var(--btnH) * var(--uiScale) * 0.85);
    padding:0 calc(10px * var(--uiScale));
    font-size:calc(12px * var(--uiScale));
  }
  #connectToggle{ background:#2563eb; color:#fff; }
  #testBtn{ background:#0ea5e9; color:#fff; }
  #runToggle{ background:#16a34a; color:#fff; }
  #fsBtn{ background:#111827; color:#fff; }

  .state{
    display:inline-flex;
    align-items:center;
    gap:calc(6px * var(--uiScale));
    height:calc(var(--btnH) * var(--uiScale));
    padding:0 calc(6px * var(--uiScale));
    font-size:calc(12px * var(--uiScale));
  }
  .badgeDot{
    width:calc(22px * var(--uiScale));
    height:calc(22px * var(--uiScale));
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:calc(11px * var(--uiScale));
    font-weight:800;
    color:#fff;
    box-shadow:0 0 0 calc(4px * var(--uiScale)) rgba(0,0,0,.06) inset;
  }
  .badgeDot.on{ background:#3b82f6; }
  .badgeDot.off{ background:#ef4444; }

  /* íŒŒì¼ ë“œë¡­ë‹¤ìš´ */
  .dropdown{ position:relative; }
  .dropdown .menu{
    position:absolute;
    right:0;
    top:calc(100% + 4px);
    min-width:140px;
    padding:6px;
    border-radius:8px;
    border:1px solid #d1d5db;
    background:#ffffff;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
    display:none;
    z-index:1000;
  }
  .dropdown .menu.show{ display:block; }
  .dropdown .menu > button{
    width:100%;
    border:0;
    background:transparent;
    padding:8px 10px;
    border-radius:6px;
    text-align:left;
    font-size:calc(13px * var(--uiScale));
    cursor:pointer;
  }
  .dropdown .menu > button:hover{ background:#f3f4f6; }
  #fileBtn{ background:#6b7280; color:#ffffff; }

  /* ===== ë©”ì¸ ë ˆì´ì•„ì›ƒ ===== */
  #main{
    display:flex;
    width:100%;
    height:calc(100vh - var(--headerH));
  }
  #left{
    flex:1 1 auto;
    min-width:0;
    height:100%;
    position:relative;
  }
  #blocklyDiv{
    width:100%;
    height:100%;
  }

  #right{
    flex:0 0 36%;
    max-width:480px;
    display:flex;
    flex-direction:column;
    margin:8px 8px 8px 0;
    border-radius:12px 0 0 12px;
    border:1px solid #e5e7eb;
    border-left:3px solid var(--blue);
    background:#ffffff;
    box-shadow:0 2px 10px rgba(0,0,0,.04);
    overflow:hidden;
  }

  #rightTop{
    padding:12px;
    border-bottom:1px solid #e5e7eb;
    background:#020617;
    color:#e5e7eb;
    font-size:13px;
  }
  #rightTop h2{
    margin:0 0 4px;
    font-size:14px;
    font-weight:700;
  }
  #rightTop p{ margin:0; line-height:1.4; }

  #rightBottom{
    flex:1 1 auto;
    display:flex;
    flex-direction:column;
    padding:10px;
    background:#020617;
    color:#d1e4ff;
  }
  #logLabel{
    font-size:12px;
    color:#9ca3af;
    margin-bottom:4px;
  }
  #log{
    flex:1 1 0;
    min-height:0;
    padding:10px;
    border-radius:8px;
    border:1px solid #1f2937;
    background:#020617;
    font-family:ui-monospace, Menlo, Consolas, monospace;
    font-size:12px;
    white-space:pre-wrap;
    overflow:auto;
  }

  @media (max-width:900px){
    #right{
      flex:0 0 42%;
      max-width:none;
    }
  }
  @media (max-width:720px){
    #main{ flex-direction:column; }
    #right{
      margin:0;
      border-radius:0;
      max-width:none;
      flex:0 0 auto;
      height:260px;
      border-left-width:1px;
      border-top:1px solid #e5e7eb;
    }
  }
</style>
</head>
<body>
<header id="appHeader">
  <div id="topbar">
    <div class="title">XROBO BLE â€” ìˆ«ì ë¸”ë¡ (ì¹´ë©”ë¼ ì¸ì‹ ì—†ìŒ)</div>
    <div class="spacer"></div>

    <!-- íŒŒì¼ ë“œë¡­ë‹¤ìš´ -->
    <div class="dropdown" id="fileDropdown">
      <button id="fileBtn" class="btn" type="button">íŒŒì¼ â–¾</button>
      <div id="fileMenu" class="menu" role="menu" aria-hidden="true">
        <button type="button" data-cmd="new">ìƒˆë¡œ ë§Œë“¤ê¸°</button>
        <button type="button" data-cmd="save">ì €ì¥í•˜ê¸°</button>
        <button type="button" data-cmd="load">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
    </div>

    <span class="state">
      <span id="statusDot" class="badgeDot off">off</span>
    </span>
    <button id="connectToggle" class="btn" type="button">ì—°ê²°</button>

    <button id="testBtn" class="btn" type="button" title="ì„ íƒí•œ ìˆ«ìë¥¼ ê°€ìƒìœ¼ë¡œ ì¸ì‹í•˜ì—¬ ì‹¤í–‰">í…ŒìŠ¤íŠ¸</button>
    <button id="runToggle" class="btn" type="button" title="í…ŒìŠ¤íŠ¸ì™€ ë™ì¼ (ì¹´ë©”ë¼ ì—†ìŒ)">ì‹¤í–‰</button>

    <button id="fsBtn" class="btn" type="button" title="ì „ì²´í™”ë©´ ì „í™˜">ì „ì²´í™”ë©´</button>
  </div>
</header>

<div id="main">
  <div id="left">
    <div id="blocklyDiv"></div>
  </div>
  <div id="right">
    <div id="rightTop">
      <h2>ì¹´ë©”ë¼ ì¸ì‹ ì œê±° ë²„ì „</h2>
      <p>
        Â· ì´ ë²„ì „ì—ì„œëŠ” <strong>ì¹´ë©”ë¼ / OCR ìˆ«ì ì¸ì‹ ì½”ë“œê°€ ì™„ì „íˆ ë¹„í™œì„±í™”</strong> ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
        Â· ë¸”ë£¨íˆ¬ìŠ¤ ì—°ê²°, ëª¨í„°/LED/ë©œë¡œë”” ë¸”ë¡ ë™ì‘ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
        Â· ìˆ«ì ì´ë²¤íŠ¸ëŠ” ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ <strong>í…ŒìŠ¤íŠ¸ / ì‹¤í–‰ ë²„íŠ¼</strong>ìœ¼ë¡œ
          <span style="color:#38bdf8;">ìˆ˜ë™ìœ¼ë¡œ</span> ì‹¤í–‰í•©ë‹ˆë‹¤.
      </p>
    </div>
    <div id="rightBottom">
      <div id="logLabel">ì‹¤í–‰ ë¡œê·¸</div>
      <div id="log"></div>
    </div>
  </div>
</div>

<!-- ë¸”ë¡ íˆ´ë°•ìŠ¤ -->
<xml id="toolbox" style="display:none">
  <category name="ì´ë²¤íŠ¸" colour="#f59e0b">
    <block type="xrobo_start"></block>
  </category>
  <category name="ì¶œë ¥" colour="#60a5fa">
    <block type="motor12_dd">
      <field name="M1">20</field>
      <field name="M2">20</field>
      <field name="MS">500</field>
    </block>
    <block type="motor12_in">
      <value name="M1"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
      <value name="M2"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
      <value name="MS"><shadow type="math_number"><field name="NUM">500</field></shadow></value>
    </block>
    <block type="melody">
      <field name="PITCH">C4</field>
      <value name="DUR"><shadow type="math_number"><field name="NUM">200</field></shadow></value>
      <value name="WAIT"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
    </block>
    <block type="led_ctrl">
      <field name="TGT">OUT1</field>
      <field name="MODE">BRIGHT</field>
      <field name="VAL">10</field>
    </block>
  </category>
  <category name="ì œì–´" colour="#10b981">
    <block type="controls_repeat_ext">
      <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
    </block>
    <block type="wait_seconds">
      <value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
    </block>
  </category>
</xml>

<script>
/* ========== ê³µìš© ========== */
const $ = (id)=>document.getElementById(id);
const logEl = $('log');
function log(msg){
  if(!logEl) return;
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

/* ========== Blockly ê¸°ë³¸ ì„¤ì • ========== */
class XroboZelosProvider extends Blockly.zelos.ConstantProvider{
  constructor(){
    super();
    this.ADD_START_HATS = true;
  }
}
class XroboZelosRenderer extends Blockly.zelos.Renderer{
  constructor(){ super('xrobo_zelos'); }
  makeConstants_(){ return new XroboZelosProvider(); }
}
Blockly.blockRendering.register('xrobo_zelos', XroboZelosRenderer);
const XroboTheme = Blockly.Theme.defineTheme('xrobo_theme', {
  base: Blockly.Themes.Zelos,
  componentStyles:{ startHats:true }
});

let ws = Blockly.inject('blocklyDiv', {
  toolbox: document.getElementById('toolbox'),
  renderer: 'xrobo_zelos',
  theme: XroboTheme,
  grid: { spacing:20, length:3, colour:'#eee', snap:true },
  zoom: { controls:true, wheel:true, startScale:1, minScale:0.5, maxScale:2 },
  move: { scrollbars:true, drag:true, wheel:true },
  trashcan:true
});

/* v12 ë³€ìˆ˜ API ê²½ê³  ì œê±°ìš© SHIM (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼í•œ ë™ì‘ ìœ ì§€ìš©) */
(function patchBlocklyDeprecated(){
  try{
    if(Blockly.Workspace && Blockly.Workspace.prototype && Blockly.Workspace.prototype.getAllVariables){
      Blockly.Workspace.prototype.getAllVariables = function(){
        const vm = this.getVariableMap ? this.getVariableMap() : null;
        return (vm && vm.getAllVariables) ? vm.getAllVariables() : [];
      };
    }
  }catch(e){}
})();

/* ë“œë˜ê·¸ ì¤‘ ìë™ ìŠ¤í¬ë¡¤ ë°©ì§€ */
(function disableAutoScrollWhileBlockDragging(){
  try{
    if(Blockly.BlockDragger && Blockly.BlockDragger.prototype){
      const orig = Blockly.BlockDragger.prototype.updateDrag;
      if(typeof orig === 'function'){
        Blockly.BlockDragger.prototype.updateDrag = function(e){
          const saved = this.autoScroll_;
          this.autoScroll_ = null;
          const r = orig.call(this, e);
          this.autoScroll_ = saved;
          return r;
        };
      }
    }
  }catch(e){}
})();

/* ========== ë¸”ë¡ ì •ì˜ ========== */
const PINS_OUT = [
  ["OUT1","OUT1"],["OUT2","OUT2"],["OUT3","OUT3"],["OUT4","OUT4"],
  ["OUT5","OUT5"],["OUT6","OUT6"],["OUT7","OUT7"],["OUT8","OUT8"]
];
const SPEEDS = Array.from({length:41},(_,i)=>20-i).map(v=>[String(v),String(v)]);
const TIMES100 = Array.from({length:10},(_,i)=>100*(i+1)).map(v=>[String(v),String(v)]);
const LED_TGT = PINS_OUT.concat([["CPU","CPU"]]);
const LED_MODE = [["ë°ê¸°","BRIGHT"],["ìˆ¨ì‰¬ê¸°","BREATHE"]];
const LED_VALS = Array.from({length:20},(_,i)=>[String(i),String(i)]);
const DIGIT_OPTIONS = Array.from({length:10},(_,i)=>[String(i),'D'+i]);

Blockly.defineBlocksWithJsonArray([
  {
    "type":"xrobo_start",
    "message0":"ìˆ«ì %1 ì´ ë³´ì´ë©´",
    "args0":[{ "type":"field_dropdown","name":"DIGIT","options": DIGIT_OPTIONS }],
    "nextStatement":null,
    "colour":36,
    "hat":"cap"
  },
  {
    "type":"motor12_dd",
    "message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
    "args0":[
      {"type":"field_dropdown","name":"M1","options":SPEEDS},
      {"type":"field_dropdown","name":"M2","options":SPEEDS},
      {"type":"field_dropdown","name":"MS","options":TIMES100}
    ],
    "previousStatement":null,
    "nextStatement":null,
    "inputsInline":true,
    "colour":210
  },
  {
    "type":"motor12_in",
    "message0":"ëª¨í„° M1 %1  M2 %2  ì‹œê°„ %3 ms",
    "args0":[
      {"type":"input_value","name":"M1","check":"Number"},
      {"type":"input_value","name":"M2","check":"Number"},
      {"type":"input_value","name":"MS","check":"Number"}
    ],
    "previousStatement":null,
    "nextStatement":null,
    "inputsInline":true,
    "colour":210
  },
  {
    "type":"melody",
    "message0":"ë©œë¡œë”” ìŒë†’ì´ %1 ì†Œë¦¬ì‹œê°„ %2 ms ëŒ€ê¸°ì‹œê°„ %3 ms",
    "args0":[
      {"type":"field_dropdown","name":"PITCH","options":(function(){
        const KR=["ë„","ë ˆ","ë¯¸","íŒŒ","ì†”","ë¼","ì‹œ"];
        const EN=["C","D","E","F","G","A","B"];
        const L=[];
        for(let o=4;o<=6;o++){
          for(let i=0;i<7;i++){
            L.push([KR[i]+o, EN[i]+o]);
          }
        }
        return L;
      })()},
      {"type":"input_value","name":"DUR","check":"Number"},
      {"type":"input_value","name":"WAIT","check":"Number"}
    ],
    "previousStatement":null,
    "nextStatement":null,
    "inputsInline":true,
    "colour":300
  },
  {
    "type":"led_ctrl",
    "message0":"LED %1 ëª¨ë“œ %2 ê°’ %3",
    "args0":[
      {"type":"field_dropdown","name":"TGT","options":LED_TGT},
      {"type":"field_dropdown","name":"MODE","options":LED_MODE},
      {"type":"field_dropdown","name":"VAL","options":LED_VALS}
    ],
    "previousStatement":null,
    "nextStatement":null,
    "inputsInline":true,
    "colour":330
  },
  {
    "type":"wait_seconds",
    "message0":"%1 ì´ˆ ê¸°ë‹¤ë¦¬ê¸°",
    "args0":[{"type":"input_value","name":"SEC","check":"Number"}],
    "previousStatement":null,
    "nextStatement":null,
    "inputsInline":true,
    "colour":120
  }
]);

/* ========== ë¸”ë¡ â†’ ëª…ë ¹ ë¦¬ìŠ¤íŠ¸ ë¹Œë“œ ========== */
function numFromInput(block, name, def){
  if(def === undefined) def = 0;
  const raw = Blockly.JavaScript.valueToCode(block, name, Blockly.JavaScript.ORDER_NONE);
  const n = Number(raw != null ? raw : '');
  return Number.isFinite(n) ? n : def;
}

function walkNode(block, list){
  if(!block) return;
  switch(block.type){
    case 'motor12_dd':{
      const v1 = +block.getFieldValue('M1');
      const v2 = +block.getFieldValue('M2');
      const ms = +block.getFieldValue('MS');
      list.push({type:'CMD', s:`M12 ${v1} ${v2} ${ms}`});
      if(ms>0) list.push({type:'W', args:[ms]});
      break;
    }
    case 'motor12_in':{
      const v1 = Math.round(numFromInput(block,'M1',0));
      const v2 = Math.round(numFromInput(block,'M2',0));
      const ms = Math.round(numFromInput(block,'MS',0));
      list.push({type:'CMD', s:`M12 ${v1} ${v2} ${ms}`});
      if(ms>0) list.push({type:'W', args:[ms]});
      break;
    }
    case 'melody':{
      const pitch = block.getFieldValue('PITCH');
      const dur = Math.round(numFromInput(block,'DUR',200));
      const wait = Math.round(numFromInput(block,'WAIT',0));
      list.push({type:'CMD', s:`MEL ${pitch} ${dur} ${wait}`});
      if(wait>0) list.push({type:'W', args:[wait]});
      break;
    }
    case 'led_ctrl':{
      const tgt = block.getFieldValue('TGT');
      const mode = block.getFieldValue('MODE');
      const val = +block.getFieldValue('VAL');
      list.push({type:'CMD', s:`LED ${tgt} ${mode} ${val}`});
      break;
    }
    case 'controls_repeat_ext':{
      const times = Math.max(0, numFromInput(block,'TIMES',1));
      const inner = [];
      const first = block.getInputTargetBlock('DO');
      walkChain(first, inner);
      list.push({type:'FOR', count:times, body:inner});
      break;
    }
    case 'wait_seconds':{
      const sec = numFromInput(block,'SEC',1);
      if(sec > 0) list.push({type:'W', args:[sec*1000]});
      break;
    }
  }
}
function walkChain(start, list){
  for(let b=start; b; b=b.getNextBlock()) walkNode(b, list);
}

function normalizeProgram(list){
  const out=[];
  for(let i=0;i<list.length;i++){
    const ins = list[i];
    if(ins.type === 'CMD'){
      const prev = out[out.length-1];
      if(prev && prev.type === 'CMD' && prev.s === ins.s) continue;
    }else if(ins.type === 'W'){
      const ms = ins.args && ins.args[0];
      if(!(ms>0)) continue;
      const prev = out[out.length-1];
      if(prev && prev.type === 'W'){
        prev.args[0] += ms;
        continue;
      }
    }
    out.push(ins);
  }
  return out;
}

function buildEventPrograms(){
  const programs = { D0:[], D1:[], D2:[], D3:[], D4:[], D5:[], D6:[], D7:[], D8:[], D9:[] };
  const evBlocks = ws.getBlocksByType('xrobo_start', true);
  for(const ev of evBlocks){
    const code = ev.getFieldValue('DIGIT') || 'D0';
    const chain = ev.getNextBlock();
    if(!chain) continue;
    const prog = [];
    walkChain(chain, prog);
    const norm = normalizeProgram(prog);
    programs[code] = programs[code].concat(norm);
  }
  return programs;
}

/* ========== UI ìŠ¤ì¼€ì¼ / í—¤ë” ë†’ì´ ========== */
function applyHeaderHeight(){
  const header = document.getElementById('appHeader');
  const h = header ? header.offsetHeight : 64;
  document.documentElement.style.setProperty('--headerH', h + 'px');
  if(ws) Blockly.svgResize(ws);
}
applyHeaderHeight();
window.addEventListener('resize', applyHeaderHeight);
document.addEventListener('fullscreenchange', applyHeaderHeight);

ws.addChangeListener(function(ev){
  if(ev && ev.type === Blockly.Events.UI && ev.element === 'zoom'){
    const s = Math.max(0.7, Math.min(1.6, ws.getScale()));
    document.documentElement.style.setProperty('--uiScale', s);
  }
});

/* ========== íŒŒì¼ ë©”ë‰´ (ìƒˆë¡œ/ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°) ========== */
const fileDropdown = $('fileDropdown');
const fileBtn = $('fileBtn');
const fileMenu = $('fileMenu');

fileBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  fileMenu.classList.toggle('show');
});
document.addEventListener('click', (e)=>{
  if(!fileDropdown.contains(e.target)){
    fileMenu.classList.remove('show');
  }
});
fileMenu.addEventListener('click', (e)=>{
  const cmd = e.target && e.target.dataset && e.target.dataset.cmd;
  if(!cmd) return;
  fileMenu.classList.remove('show');
  if(cmd === 'new') newProject();
  else if(cmd === 'save') saveProject();
  else if(cmd === 'load') loadProject();
});

function newProject(){
  if(confirm('í˜„ì¬ ë¸”ë¡ì„ ëª¨ë‘ ì§€ìš°ê³  ìƒˆë¡œ ì‹œì‘í• ê¹Œìš”?')){
    ws.clear();
    log('ğŸ§¹ ìƒˆ í”„ë¡œì íŠ¸ ì‹œì‘');
  }
}

function saveProject(){
  try{
    const xmlDom = Blockly.Xml.workspaceToDom(ws);
    const xmlText = Blockly.Xml.domToText(xmlDom);
    const blob = new Blob([xmlText], {type:'text/xml'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'xrobo_number_project.xml';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    log('ğŸ’¾ í”„ë¡œì íŠ¸ ì €ì¥(ë‹¤ìš´ë¡œë“œ) ì™„ë£Œ');
  }catch(e){
    alert('ì €ì¥ ì‹¤íŒ¨: ' + e);
  }
}

function loadProject(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.xml,text/xml,application/xml';
  input.onchange = async ()=>{
    const file = input.files && input.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const dom = Blockly.Xml.textToDom(text);
      ws.clear();
      Blockly.Xml.domToWorkspace(dom, ws);
      log('ğŸ“‚ í”„ë¡œì íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ');
    }catch(e){
      alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e);
    }
  };
  input.click();
}

/* ========== BLE í†µì‹  ========== */
const SERVICE_UUID = 0xFFF0;
let bleDevice = null;
let bleServer = null;
let bleService = null;
let writeChar = null;
let notifyChar = null;
let isConnected = false;

const enc = (s)=> new TextEncoder().encode(s);

const btnConnect = $('connectToggle');
const btnTest = $('testBtn');
const btnRun = $('runToggle');
const fsBtn = $('fsBtn');
const statusDot = $('statusDot');

function setConnected(v){
  isConnected = v;
  if(v){
    statusDot.classList.remove('off');
    statusDot.classList.add('on');
    statusDot.textContent = 'on';
    btnConnect.textContent = 'í•´ì œ';
  }else{
    statusDot.classList.remove('on');
    statusDot.classList.add('off');
    statusDot.textContent = 'off';
    btnConnect.textContent = 'ì—°ê²°';
  }
}

async function connectBLE(){
  if(!navigator.bluetooth){
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    return;
  }
  try{
    const device = await navigator.bluetooth.requestDevice({
      filters:[{ namePrefix:'XROBO' }],
      optionalServices:[SERVICE_UUID]
    });
    bleDevice = device;
    bleDevice.addEventListener('gattserverdisconnected', ()=>{
      log('ğŸ”Œ BLE í•´ì œë¨');
      setConnected(false);
      bleServer = bleService = writeChar = notifyChar = null;
    });

    bleServer = await bleDevice.gatt.connect();
    bleService = await bleServer.getPrimaryService(SERVICE_UUID);

    const chars = await bleService.getCharacteristics();
    writeChar = null;
    notifyChar = null;
    for(const ch of chars){
      const p = ch.properties || {};
      if(!writeChar && (p.write || p.writeWithoutResponse)) writeChar = ch;
      if(!notifyChar && p.notify) notifyChar = ch;
    }
    if(!writeChar) throw new Error('write íŠ¹ì„±ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');

    if(notifyChar){
      await notifyChar.startNotifications();
      notifyChar.addEventListener('characteristicvaluechanged',(ev)=>{
        try{
          const v = new TextDecoder().decode(ev.target.value || new Uint8Array());
          log('â¬…ï¸ ' + v.trim());
        }catch(e){}
      });
    }

    setConnected(true);
    log('âœ… ì—°ê²°: ' + (device.name || '(ì´ë¦„ ì—†ìŒ)'));
  }catch(e){
    log('âŒ ì—°ê²° ì‹¤íŒ¨: ' + e);
    setConnected(false);
    bleDevice = bleServer = bleService = writeChar = notifyChar = null;
  }
}

function disconnectBLE(){
  try{
    if(bleDevice && bleDevice.gatt && bleDevice.gatt.connected){
      bleDevice.gatt.disconnect();
    }
  }catch(e){}
  setConnected(false);
  bleDevice = bleServer = bleService = writeChar = notifyChar = null;
  log('ğŸ”Œ ìˆ˜ë™ í•´ì œ');
}

btnConnect.addEventListener('click', ()=>{
  if(isConnected) disconnectBLE();
  else connectBLE();
});

function sendRaw(s){
  if(!writeChar){
    log('â¡ï¸(BLE ë¯¸ì—°ê²°) ' + s);
    return Promise.resolve();
  }
  return writeChar.writeValue(enc(s + '\n'))
    .then(()=>{ log('â¡ï¸ ' + s); })
    .catch(e=>{
      log('âš ï¸ ì „ì†¡ ì‹¤íŒ¨: ' + e);
    });
}

/* ========== ì‹¤í–‰ í & ìˆ«ì ì´ë²¤íŠ¸ ì‹¤í–‰ ========== */
let eventPrograms = {};
let queue = [];
let queueBusy = false;
let cancelToken = 0;

function enqueue(list){
  queue.push({list});
  processQueue(cancelToken);
}

async function runList(list, localToken){
  for(let i=0;i<list.length;i++){
    if(localToken !== cancelToken) return;
    const ins = list[i];
    if(ins.type === 'CMD'){
      await sendRaw(ins.s);
    }else if(ins.type === 'W'){
      const ms = ins.args && ins.args[0] ? ins.args[0] : 0;
      if(ms>0){
        await new Promise(res=>setTimeout(res, ms));
      }
    }else if(ins.type === 'FOR'){
      for(let k=0;k<ins.count;k++){
        if(localToken !== cancelToken) return;
        await runList(ins.body, localToken);
      }
    }
  }
}

async function processQueue(localToken){
  if(queueBusy) return;
  queueBusy = true;
  try{
    while(queue.length && localToken === cancelToken){
      const item = queue.shift();
      await runList(item.list, localToken);
    }
  }finally{
    queueBusy = false;
  }
}

function runProgramsForDigit(code){
  if(!eventPrograms[code] || eventPrograms[code].length === 0){
    log('âš ï¸ ìˆ«ì ' + code.replace('D','') + ' ì— ì—°ê²°ëœ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  enqueue(eventPrograms[code]);
}

/* ========== í…ŒìŠ¤íŠ¸ / ì‹¤í–‰ ë²„íŠ¼ (ì¹´ë©”ë¼ ì—†ì´ ìˆ˜ë™ ìˆ«ì ì„ íƒ) ========== */
function askDigit(){
  const inp = prompt('ê°€ìƒìœ¼ë¡œ ì¸ì‹í•  ìˆ«ì(0~9)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', '0');
  if(inp === null) return null;
  const n = Number(inp.trim());
  if(!Number.isInteger(n) || n < 0 || n > 9){
    alert('0ë¶€í„° 9 ì‚¬ì´ì˜ ì •ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return null;
  }
  return n;
}

function runOnceManual(){
  // í•­ìƒ ìµœì‹  ë¸”ë¡ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œê·¸ë¨ ë¹Œë“œ
  eventPrograms = buildEventPrograms();
  const d = askDigit();
  if(d === null) return;
  const key = 'D' + d;
  log('â–¶ ìˆ«ì ' + d + ' ì„(ë¥¼) ì¸ì‹í•œ ê²ƒìœ¼ë¡œ ê°€ì •í•˜ê³  ì‹¤í–‰');
  runProgramsForDigit(key);
}

btnTest.addEventListener('click', runOnceManual);

// ì‹¤í–‰ ë²„íŠ¼ë„ í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ì™€ ë™ì¼í•˜ê²Œ ë™ì‘ (ì¹´ë©”ë¼ ì¸ì‹ì´ ì—†ê¸° ë•Œë¬¸)
btnRun.addEventListener('click', runOnceManual);

/* ========== ì „ì²´í™”ë©´ ë²„íŠ¼ ========== */
function syncFsLabel(){
  const fs = !!document.fullscreenElement;
  fsBtn.textContent = fs ? 'í™”ë©´ì¶•ì†Œ' : 'ì „ì²´í™”ë©´';
}
fsBtn.addEventListener('click', async ()=>{
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){
    console.error(e);
  }
});
document.addEventListener('fullscreenchange', syncFsLabel);
syncFsLabel();

/* ì´ˆê¸° ë¡œê·¸ */
log('â„¹ï¸ ì¹´ë©”ë¼/OCR ìˆ«ì ì¸ì‹ì´ ì œê±°ëœ number.html ë²„ì „ì…ë‹ˆë‹¤.');
log('â„¹ï¸ ìˆ«ì ì´ë²¤íŠ¸ëŠ” ìƒë‹¨ì˜ [í…ŒìŠ¤íŠ¸] ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ì‹¤í–‰í•˜ì„¸ìš”.');
</script>
</body>
</html>
