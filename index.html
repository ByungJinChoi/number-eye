<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ìˆ«ì ì¸ì‹ OCR í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <!-- Tesseract.js (ë¸Œë¼ìš°ì € OCR ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:#f3f4f6;
      color:#111827;
    }
    header{
      padding:10px 14px;
      background:linear-gradient(180deg,#fff7ed,#fffbeb);
      border-bottom:1px solid #fed7aa;
    }
    header h1{
      margin:0;
      font-size:18px;
      font-weight:800;
      color:#7c2d12;
    }
    header p{
      margin:4px 0 0;
      font-size:13px;
      color:#6b7280;
    }

    main{
      padding:12px;
      max-width:900px;
      margin:0 auto;
    }

    #videoArea{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-start;
    }

    #videoBox{
      position:relative;
      flex:1 1 280px;
      min-width:260px;
      max-width:480px;
      background:#000;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(15,23,42,.35);
    }
    #video{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
      transform:scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
    }
    #focusBox{
      position:absolute;
      left:50%;
      top:50%;
      width:48%;
      aspect-ratio:1/1;
      transform:translate(-50%,-50%);
      border:2px solid rgba(255,255,255,.9);
      border-radius:12px;
      box-shadow:0 0 0 2px rgba(0,0,0,.35), 0 0 18px rgba(0,255,220,.35);
      pointer-events:none;
    }
    #badge{
      position:absolute;
      left:12px;
      top:12px;
      font-size:11px;
      font-weight:700;
      color:#fff;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.4);
      background:rgba(0,0,0,.45);
      backdrop-filter:blur(6px);
    }

    #controls{
      flex:0 0 220px;
      min-width:220px;
      padding:10px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.18);
    }
    #controls h2{
      margin:0 0 8px;
      font-size:15px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      margin:3px 0;
      border-radius:999px;
      border:0;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      background:#e5e7eb;
      color:#111827;
    }
    .btn:disabled{
      opacity:.55;
      cursor:default;
      box-shadow:none;
    }
    #initOcrBtn{ background:#0ea5e9; color:#fff; }
    #camBtn{ background:#22c55e; color:#fff; }

    #autoWrap{
      margin-top:6px;
      font-size:13px;
      color:#4b5563;
    }

    #resultPanel{
      margin-top:12px;
      padding:10px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
      font-size:14px;
    }
    #resultPanel .row{
      margin:4px 0;
    }
    #digit{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:26px;
      font-weight:900;
      padding:2px 8px;
      border-radius:8px;
      background:#0f172a;
      color:#f9fafb;
      display:inline-block;
      min-width:1ch;
      text-align:center;
    }
    #confidence{
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    #rawText{
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:12px;
      background:#f3f4f6;
      padding:3px 6px;
      border-radius:6px;
      word-break:break-all;
    }

    #logBox{
      margin-top:12px;
    }
    #log{
      width:100%;
      height:160px;
      padding:8px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      background:#0b1120;
      color:#e5e7eb;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:12px;
      white-space:pre-wrap;
      overflow:auto;
    }

    footer{
      margin:10px auto 18px;
      max-width:900px;
      padding:0 12px;
      font-size:11px;
      color:#6b7280;
    }

    @media (max-width:640px){
      #videoArea{
        flex-direction:column;
      }
      #controls{
        width:100%;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>ìˆ«ì ì¸ì‹ OCR í…ŒìŠ¤íŠ¸</h1>
  <p>1) ë¨¼ì € [OCR ì´ˆê¸°í™”] â†’ 2) [ì¹´ë©”ë¼ ì¼œê¸°] â†’ 3) ì¤‘ì•™ ë°•ìŠ¤ì— ìˆ«ìë¥¼ ë³´ì—¬ ì£¼ì„¸ìš”.</p>
</header>

<main>
  <section id="videoArea">
    <div id="videoBox">
      <video id="video" autoplay playsinline muted></video>
      <div id="focusBox"></div>
      <div id="badge">ì¹´ë©”ë¼: êº¼ì§</div>
    </div>

    <div id="controls">
      <h2>ì¡°ì‘ ë²„íŠ¼</h2>
      <button id="initOcrBtn" class="btn">OCR ì´ˆê¸°í™”</button><br/>
      <button id="camBtn" class="btn">ì¹´ë©”ë¼ ì¼œê¸°</button><br/>
      <button id="onceBtn" class="btn">í•œ ë²ˆë§Œ ì½ê¸°</button>

      <div id="autoWrap">
        <label>
          <input type="checkbox" id="autoChk" checked />
          ìë™ìœ¼ë¡œ ê³„ì† ìˆ«ì ì¸ì‹ (ì•½ 1~1.5ì´ˆ ê°„ê²©)
        </label>
      </div>
    </div>
  </section>

  <section id="resultPanel">
    <div class="row">ì¸ì‹ëœ ìˆ«ì: <span id="digit">â€”</span></div>
    <div class="row">ì‹ ë¢°ë„(ê°€ì¥ í™•ì‹ í•˜ëŠ” ìˆ«ì): <span id="confidence">-</span> %</div>
    <div class="row">ì›ë³¸ í…ìŠ¤íŠ¸(ë””ë²„ê·¸ìš©): <span id="rawText"></span></div>
  </section>

  <section id="logBox">
    <div style="font-size:13px;margin-bottom:4px;color:#6b7280;">ë¡œê·¸</div>
    <pre id="log"></pre>
  </section>
</main>

<footer>
  ì¤‘ì•™ì˜ ë„¤ëª¨ ë°•ìŠ¤ ì•ˆì— 0~9 ìˆ«ìê°€ ì˜ ë³´ì´ë„ë¡ ê°€ê¹Œì´ ê°€ì ¸ê°€ ì£¼ì„¸ìš”. ë°°ê²½ì´ ë„ˆë¬´ ì–´ë‘¡ê±°ë‚˜ ìˆ«ìê°€ ë§ì´ íë¦¿í•˜ë©´ ì¸ì‹ì´ ì˜ ì•ˆë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
</footer>

<!-- ì¹´ë©”ë¼ í”„ë ˆì„ ìº¡ì²˜ìš© ìº”ë²„ìŠ¤ (í™”ë©´ì—ëŠ” ë³´ì´ì§€ ì•ŠìŒ) -->
<canvas id="capture" width="224" height="224" style="display:none"></canvas>

<script>
  const video = document.getElementById('video');
  const badge = document.getElementById('badge');
  const digitEl = document.getElementById('digit');
  const confEl = document.getElementById('confidence');
  const rawEl = document.getElementById('rawText');
  const logEl = document.getElementById('log');
  const capture = document.getElementById('capture');
  const ctx = capture.getContext('2d', { willReadFrequently: true });

  const initOcrBtn = document.getElementById('initOcrBtn');
  const camBtn = document.getElementById('camBtn');
  const onceBtn = document.getElementById('onceBtn');
  const autoChk = document.getElementById('autoChk');

  let stream = null;
  let ocrWorker = null;
  let ocrReady = false;
  let ocrBusy  = false;
  let autoTimer = null;

  const OCR_SIZE = 224;        // OCR ì…ë ¥ í•´ìƒë„ (ì •ì‚¬ê°í˜•)
  const OCR_MIN_CONF = 55;     // ìµœì†Œ ì‹ ë¢°ë„(%) ê¸°ì¤€

  function log(msg){
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  /* =============== OCR ì´ˆê¸°í™” =============== */
  async function initOcr(){
    if (ocrReady){
      log("â„¹ï¸ OCRëŠ” ì´ë¯¸ ì¤€ë¹„ ìƒíƒœì…ë‹ˆë‹¤.");
      return;
    }
    if (!window.Tesseract){
      log("âŒ Tesseract.js ë¡œë“œ ì‹¤íŒ¨(ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”).");
      return;
    }
    try{
      log("âš™ï¸ OCR ì´ˆê¸°í™” ì¤‘... (ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
      // v5(ìƒˆ ë²„ì „) ìš°ì„  ì‹œë„
      try{
        ocrWorker = await Tesseract.createWorker('eng', 1, {
          logger: m => { /* í•„ìš”í•˜ë©´ console.log(m) */ }
        });
      }catch(e){
        // êµ¬ë²„ì „(v2) í´ë°±
        log("â„¹ï¸ createWorker('eng',...) ì‹¤íŒ¨, êµ¬ë²„ì „ ë°©ì‹ìœ¼ë¡œ ì¬ì‹œë„: " + e);
        ocrWorker = Tesseract.createWorker({ logger: m => { /* console.log(m); */ } });
        if (ocrWorker.load)         await ocrWorker.load();
        if (ocrWorker.loadLanguage) await ocrWorker.loadLanguage('eng');
        if (ocrWorker.initialize)   await ocrWorker.initialize('eng');
      }

      if (ocrWorker.setParameters){
        // SINGLE_CHAR(í•œ ê¸€ì) ì—†ìœ¼ë©´ 10ë²ˆ ëª¨ë“œ ì‚¬ìš©
        const psmSingle = (Tesseract.PSM && (Tesseract.PSM.SINGLE_CHAR || Tesseract.PSM.SINGLE_BLOCK))
                          ? (Tesseract.PSM.SINGLE_CHAR || Tesseract.PSM.SINGLE_BLOCK)
                          : 10;
        await ocrWorker.setParameters({
          tessedit_char_whitelist: '0123456789',
          tessedit_pageseg_mode: psmSingle,
          user_defined_dpi: '300'
        });
      }

      ocrReady = true;
      log("âœ… OCR ì¤€ë¹„ ì™„ë£Œ");
    }catch(err){
      console.error(err);
      log("âŒ OCR ì´ˆê¸°í™” ì‹¤íŒ¨: " + err);
    }
  }

  /* =============== ì¹´ë©”ë¼ on/off =============== */
  async function startCam(){
    if (stream) return;
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      log("âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼(getUserMedia)ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    try{
      log("ğŸ“· ì¹´ë©”ë¼ ìš”ì²­ ì¤‘...");
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' }, // í›„ë©´ ì¹´ë©”ë¼ ì„ í˜¸
          width: { ideal: 640 },
          height: { ideal: 480 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
      badge.textContent = "ì¹´ë©”ë¼: ì¼œì§";
      camBtn.textContent = "ì¹´ë©”ë¼ ë„ê¸°";
      camBtn.style.background = "#ef4444";
      log("âœ… ì¹´ë©”ë¼ ì‹œì‘");
      // ìë™ ëª¨ë“œ ì¼œì ¸ ìˆê³ , OCR ì¤€ë¹„ê°€ ë˜ì–´ ìˆìœ¼ë©´ ìë™ ì¸ì‹ ì‹œì‘
      if (autoChk.checked && ocrReady) startAuto();
    }catch(err){
      console.error(err);
      log("âŒ ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨: " + err);
    }
  }

  function stopCam(){
    if (!stream) return;
    try{
      const tracks = stream.getTracks();
      tracks.forEach(t => t.stop());
    }catch(_){}
    stream = null;
    video.srcObject = null;
    badge.textContent = "ì¹´ë©”ë¼: êº¼ì§";
    camBtn.textContent = "ì¹´ë©”ë¼ ì¼œê¸°";
    camBtn.style.background = "#22c55e";
    log("ğŸ›‘ ì¹´ë©”ë¼ ì¤‘ì§€");
    stopAuto();
  }

  /* =============== í•œ í”„ë ˆì„ OCR =============== */
  async function recognizeOnce(){
    if (!ocrReady){
      log("âš ï¸ ë¨¼ì € [OCR ì´ˆê¸°í™”] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
      return;
    }
    if (!stream || video.readyState < 2){
      log("âš ï¸ ì¹´ë©”ë¼ê°€ ì¼œì ¸ ìˆì§€ ì•Šê±°ë‚˜ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    if (ocrBusy) return;  // ì´ì „ ì‘ì—…ì´ ì•„ì§ ì•ˆ ëë‚¬ìœ¼ë©´ ê±´ë„ˆëœ€

    ocrBusy = true;
    digitEl.textContent = "â€¦";
    confEl.textContent = "-";
    try{
      const vw = video.videoWidth  || 640;
      const vh = video.videoHeight || 480;

      // ë¹„ë””ì˜¤ ê°€ìš´ë° ì •ì‚¬ê°í˜• ì˜ì—­ë§Œ ì˜ë¼ ì‚¬ìš©
      const side = Math.floor(Math.min(vw, vh) * 0.6);
      const sx = Math.floor((vw - side) / 2);
      const sy = Math.floor((vh - side) / 2);

      capture.width = OCR_SIZE;
      capture.height = OCR_SIZE;
      ctx.drawImage(video, sx, sy, side, side, 0, 0, OCR_SIZE, OCR_SIZE);

      // ê°„ë‹¨í•œ ì „ì²˜ë¦¬: ê·¸ë ˆì´ìŠ¤ì¼€ì¼ + ì´ì§„í™”
      const img = ctx.getImageData(0, 0, OCR_SIZE, OCR_SIZE);
      const d = img.data;
      let sum = 0;
      for (let i = 0; i < d.length; i += 4){
        const r = d[i], g = d[i+1], b = d[i+2];
        const gray = (r*0.299 + g*0.587 + b*0.114) | 0;
        d[i] = d[i+1] = d[i+2] = gray;
        sum += gray;
      }
      const mean = sum / (OCR_SIZE * OCR_SIZE);
      const th = Math.max(50, Math.min(220, mean - 10)); // í‰ê· ë³´ë‹¤ ì¡°ê¸ˆ ë‚®ì€ ê°’
      for (let i = 0; i < d.length; i += 4){
        const v = d[i] < th ? 0 : 255; // ì–´ë‘ìš´ ê¸€ì / ë°ì€ ë°°ê²½ ê°€ì •
        d[i] = d[i+1] = d[i+2] = v;
        d[i+3] = 255;
      }
      ctx.putImageData(img, 0, 0);

      log("ğŸ” í•œ í”„ë ˆì„ OCR ì‹œë„ ì¤‘...");
      const res = await ocrWorker.recognize(capture);

      const rawText = (res && res.data && res.data.text) ? res.data.text : "";
      rawEl.textContent = rawText.replace(/\s+/g, " ").trim();

      let bestDigit = null;
      let bestConf = -1;

      if (res && res.data && Array.isArray(res.data.symbols)){
        for (const s of res.data.symbols){
          const ch = (s.text || "").trim();
          if (/^[0-9]$/.test(ch)){
            const c = typeof s.confidence === "number" ? s.confidence : 0;
            if (c > bestConf){
              bestConf = c;
              bestDigit = ch;
            }
          }
        }
      }

      // symbols ì—ì„œ ëª» ì°¾ìœ¼ë©´ text ì „ì²´ì—ì„œ ìˆ«ìë§Œ ë½‘ê¸°
      if (bestDigit === null){
        const onlyDigits = rawText.replace(/[^0-9]/g, "");
        if (onlyDigits.length > 0){
          bestDigit = onlyDigits[0];
          bestConf = 0;
        }
      }

      if (bestDigit !== null && bestConf >= OCR_MIN_CONF){
        digitEl.textContent = bestDigit;
        confEl.textContent = bestConf.toFixed(1);
        log("âœ… ìˆ«ì ì¸ì‹: " + bestDigit + " (conf=" + bestConf.toFixed(1) + ")");
      }else if(bestDigit !== null){
        digitEl.textContent = bestDigit;
        confEl.textContent = bestConf.toFixed(1);
        log("âš ï¸ ìˆ«ìë¥¼ ì°¾ì•˜ì§€ë§Œ ì‹ ë¢°ë„ê°€ ë‚®ìŠµë‹ˆë‹¤: " +
            bestDigit + " (conf=" + bestConf.toFixed(1) + ")");
      }else{
        digitEl.textContent = "â€”";
        confEl.textContent = "-";
        log("â“ ìˆ«ìë¥¼ í™•ì‹¤í•˜ê²Œ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
    }catch(err){
      console.error(err);
      digitEl.textContent = "Ã—";
      confEl.textContent = "-";
      log("âŒ OCR ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜: " + err);
    }finally{
      ocrBusy = false;
    }
  }

  /* =============== ìë™ ë°˜ë³µ ëª¨ë“œ =============== */
  function startAuto(){
    if (autoTimer) return;
    autoTimer = setInterval(()=>{
      recognizeOnce();
    }, 1300); // 1.3ì´ˆë§ˆë‹¤ í•œë²ˆ
    log("â–¶ï¸ ìë™ ì¸ì‹ ì‹œì‘");
  }
  function stopAuto(){
    if (!autoTimer) return;
    clearInterval(autoTimer);
    autoTimer = null;
    log("â¹ ìë™ ì¸ì‹ ì¤‘ì§€");
  }

  /* =============== ì´ë²¤íŠ¸ ë°”ì¸ë”© =============== */
  initOcrBtn.addEventListener('click', initOcr);
  camBtn.addEventListener('click', ()=>{
    if (stream) stopCam();
    else startCam();
  });
  onceBtn.addEventListener('click', recognizeOnce);

  autoChk.addEventListener('change', ()=>{
    if (autoChk.checked){
      if (stream && ocrReady) startAuto();
    }else{
      stopAuto();
    }
  });

  // í˜ì´ì§€ ë– ë‚  ë•Œ ì¹´ë©”ë¼ ì •ë¦¬
  window.addEventListener('beforeunload', ()=>{
    stopAuto();
    if (stream){
      try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){}
    }
  });
</script>
</body>
</html>
